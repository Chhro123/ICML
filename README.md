# STAGE: Segmentation-aware Anomaly Synthesis via Graded Diffusion with Explicit Mask Alignment

## 📌 Introduction
**STAGE** (**Phased Anomaly Diffusion with Progressive Mask Alignment**) is a novel **anomaly synthesis framework** designed for **anomaly segmentation** tasks. It overcomes key limitations of existing Anomaly Synthesis (AS) methods by generating **high-fidelity, well-aligned, and fine-grained** synthetic anomalies, significantly enhancing anomaly segmentation performance.

### 🔹 Key Challenges in Anomaly Synthesis:
- **Lack of fine-grained texture** – Existing methods struggle to generate realistic anomaly textures.
- **Poor pixel alignment** – Many generative methods fail to properly align synthetic anomalies with the background.
- **Ignoring small anomalies** – Small, fine-grained anomalies are often overlooked during synthesis.

### ✅ How STAGE Solves These Problems:
1. **Phased Diffusion Sampling:** Injects real background information into the denoising process, ensuring realistic texture synthesis.
2. **Progressive Mask Alignment (PMA):** Smooths anomaly-background transitions, preventing misalignment artifacts.
3. **Dual-Branch Anomaly Synthesis:** Ensures small anomalies are effectively generated by integrating a dedicated **anomaly-only branch**.

STAGE achieves **state-of-the-art** (SOTA) performance on **MVTec-AD** and **BTAD** datasets, surpassing existing AS methods.

---

<!-- ## 📄 Paper
If you find this work useful, please cite:

```bibtex
@inproceedings{STAGE2025,
  author = {Anonymous Authors},
  title = {STAGE: Segmentation-aware Anomaly Synthesis via Graded Diffusion with Explicit Mask Alignment},
  booktitle = {International Conference on Machine Learning (ICML)},
  year = {2025}
}
``` -->

---

## 🏗️ Repository Structure
```
├── Seg_log/                 # Logs of downstream segmentation models
├── configs/                # Model configuration files
├── datasets/               # Data preprocessing scripts
├── ldm/                    # STAGE model implementation
├── taming/                    # Basic functions
├── scripts/                
├── utils/                  # Utility functions
├── main.py                 # Entry point for training and testing
├── requirements.txt        # Required Python packages
├── README.md               # This file
```

---

## 🚀 Training STAGE
To train STAGE on MVTec-AD:

```bash
python main.py --base config_file -t --actual_resume models/ldm/text2img-large/model.ckpt -n test --gpus 0, --init_word "word"  --mvtec_path='mvtec_data_path/'  --log_folder "save_log_path" 
```
For BTAD dataset:
```bash
python main.py --base config_file -t --actual_resume models/ldm/text2img-large/model.ckpt -n test --gpus 0, --init_word "word"  --mvtec_path='btad_data_path/'  --log_folder "save_log_path" 
```


## 🧐 Evaluation & Inference
Run inference on test images:

```bash
python generate_with_mask_mvtec.py --data_root='normal_data_path' --weight_idx weight_param --sample_name='save_image_folder' --init_word "word" --anomaly_name='save_image_subfolder' --pt_path='weight_path/' --mask_path='mask_path/'
```

Results will be saved in `save_image_folder/` directory.

---


## 📢 Acknowledgments
This work is built upon **Denoising Diffusion Models** and **Latent Diffusion Models (LDMs)**. We acknowledge contributions from prior work in **anomaly detection and segmentation**.

For questions or contributions, feel free to open an **Issue** or submit a **Pull Request**.

---

## 📜 License
This project is released under the **MIT License**.

---
